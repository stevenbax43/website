{% extends 'home/base.html'%}
{% load static %}

{% block extra_css %}
  <!-- Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <!-- Your chat styles -->
  <link rel="stylesheet" href="{% static 'chat/styles/chat.css'%}">
{% endblock %}

{% block content_wrapper_start %}{% endblock %}
{% block content_wrapper_end %}{% endblock %}

{% block content %}
{% csrf_token %}

<!-- HERO -->
<header class="tools-hero">
  <div class="container py-3">
    <div class="row align-items-center g-3 flex-nowrap">
      <div class="col">
        <h1 class="display-6 mb-0 text-white">Chatbot</h1>
      </div>
      <div class="col-auto">
        <a href="{% url 'chat:create_new_conversation' %}" class="d-inline-block" title="Nieuw gesprek">
          <img src="{% static 'chat/images/chatbot.png' %}" class="hero-icon" alt="Chatbot">
        </a>
      </div>
    </div>
  </div>
</header>

<!-- INTRO -->
<section class="tools-intro no-print">
  <div class="container py-3">
    <div class="row align-items-center g-3">
      <div class="col-12 col-lg-8">
        <p class="lead mb-1">
          Welkom <strong>{{ user.first_name }} {{ user.last_name }}</strong>!
        </p>
        <p class="mb-0">
          Dit is jouw persoonlijke omgeving om vragen te stellen aan O&amp;T via een custom-trained AI-chatbot.
          De bot is getraind op normen en eisen. <strong>Deel geen gevoelige informatie.</strong>
        </p>
      </div>
      <div class="col-12 col-lg-4 d-flex justify-content-lg-end">
        <!-- Keep username available for JS if needed -->
        <span id="current_username" class="d-none" style="text-transform: uppercase;">{{ user.username }}</span>
      </div>
    </div>
  </div>
</section>

<!-- MAIN -->
<section class="py-3">
  <div class="container">
    <div class="row g-4">

      <!-- Sidebar: saved conversations -->
      <aside class="col-12 col-lg-4 col-xl-3">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h2 class="h6 mb-0">Opgeslagen gesprekken</h2>
            <a href="{% url 'chat:create_new_conversation' %}" class="create-link" title="Nieuw gesprek">
              <img src="{% static 'chat/images/new-conversation.png' %}" alt="Nieuw" style="height:28px;">
            </a>
          </div>

          <div class="card-body p-0">
            <ul class="list-group list-group-flush">
              {% for conversation in conversations %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div class="conversation-title me-2">
                    <a href="{% url 'chat:chatbot_with_conversation' pk=conversation.pk %}" class="text-decoration-none">
                      {{ conversation.title }}
                      <input type="hidden" id="conversation-id" value="{{ selected_conversation.pk }}">
                    </a>
                  </div>
                  <form action="{% url 'chat:delete_specific_conversation' pk=conversation.pk %}" method="post" class="ms-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Verwijderen">
                      <img src="{% static 'chat/images/delete-icon.png' %}" alt="Delete" style="height:18px;">
                    </button>
                  </form>
                </li>
              {% empty %}
                <li class="list-group-item text-muted">Geen gesprekken gevonden.</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </aside>

      <!-- Chat area -->
      <main class="col-12 col-lg-8 col-xl-9">
        <div id="chat-container" class="card shadow-sm">
          <!-- header with current conversation title -->
          <div class="card-header bg-white">
            {% if selected_conversation %}
              <h2 class="h5 mb-0">{{ selected_conversation.title }}</h2>
            {% else %}
              <h2 class="h6 mb-0 text-muted">Selecteer of start een gesprek</h2>
            {% endif %}
          </div>

          <!-- chat history -->
          <div class="card-body">
            <div id="chat-display" class="mb-3">
              {% if user_bot_responses %}
                {% for user_bot_response in user_bot_responses %}
                  <!-- user message -->
                  <div class="message mb-2 user-message d-flex align-items-start justify-content-end">
                    <div class="user_chat wrap me-2">
                      <strong>Jij</strong><br>
                      {{ user_bot_response.user_input }}
                    </div>
                    <div class="circle_user first-letters">
                      {{ request.user.username|slice:":2"|upper }}
                    </div>
                  </div>
                  <!-- bot message -->
                  <div class="message mb-2 bot-message d-flex align-items-start">
                    <div class="circle_bot me-2">K</div>
                    <div class="bot_response wrap">
                      <strong>Chatbot</strong><br>
                      {{ user_bot_response.bot_response|safe }}
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <h3 id="start_new_conversation" class="h6 text-muted">Start nieuw gesprek</h3>
              {% endif %}
            </div>

            <!-- hidden chat name for JS (kept) -->
            <input type="hidden" id="chat_name" value="{{ chat_name }}">
          </div>

          <!-- input -->
          <div class="card-footer bg-white">
            <div id="user-input-container" class="input-group">
              <input
                type="text"
                id="user_input"
                class="form-control"
                placeholder="Schrijf je bericht..."
                onkeyup="handleEnterKey(event)"
                autocomplete="off"
              >
              <button id="send-button" class="btn btn-success" onclick="sendMessage()">
                <span class="arrow-up-icon">&#9650;</span>
              </button>
            </div>
          </div>
        </div>
      </main>

    </div>
  </div>
</section>

{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'chat/scripts/chat.js' %}"></script>
{% endblock %}
