{% extends 'home/base.html'%}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'forum/styles/forum.css'%}">
{% endblock %}

{% block content_wrapper_start %}{% endblock %}
{% block content_wrapper_end %}{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Hero (same vibe as the list page) -->
<header class="tools-hero">
  <div class="container py-3">
    <div class="row align-items-center g-3 flex-nowrap">
      <div class="col">
        <h1 class="display-6 mb-0 text-white">Forum</h1>
      </div>
      <div class="col-auto">
        <a href="{% url 'forum:topic_list' %}" class="d-inline-block">
          <img src="{% static 'forum/images/forum.png' %}" class="hero-icon" alt="Forum">
        </a>
      </div>
    </div>
  </div>
</header>

<!-- Intro -->
<section class="tools-intro no-print">
  <div class="container py-3">
    <div class="row align-items-center g-3">
      <div class="col-12 col-lg-8">
        <p class="lead mb-0">
          Discussieer mee. Suggesties, op- en aanmerkingen zijn welkom — reageer gerust op elkaar.
        </p>
      </div>
      <div class="col-12 col-lg-4 d-flex justify-content-lg-end gap-2">
        <a href="{% url 'forum:topic_list' %}" class="btn btn-outline-secondary btn-sm">Terug naar Topics</a>
      </div>
    </div>
  </div>
</section>

<section class="py-3">
  <div class="container">

    <!-- Category + topic header -->
    <div class="d-flex align-items-center gap-2 pb-2 mb-3 border-bottom">
      {% if topic.is_closed %}
        <img src="{% static 'forum/images/closed-sm.png' %}" alt="closed" class="me-1" style="width: 28px; height: 28px;">
      {% endif %}
      <h2 class="h5 mb-0">{{ topic.category.name }}</h2>
      {% if topic.category.image %}
        <img src="{{ topic.category.image.url }}" alt="{{ topic.category.name }}" class="ms-2 rounded" style="height: 28px; width:auto;">
      {% endif %}
      <span class="ms-auto badge {% if topic.is_closed %}bg-secondary{% else %}bg-success{% endif %}">
        {% if topic.is_closed %}Gesloten{% else %}Open{% endif %}
      </span>
    </div>

    <!-- Topic card -->
    <article class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-2">
          <h3 class="h4 mb-0">{{ topic.title }}</h3>
          <small class="text-muted">
            Gemaakt door <strong>{{ topic.created_by }}</strong>
            <span class="mx-1">•</span>
            <time datetime="{{ topic.created_at|date:'c' }}">{{ topic.created_at }}</time>
          </small>
        </div>
        <div class="topic-content">
          {{ topic.content|safe }}
        </div>
      </div>
      {% if request.user == topic.created_by and not topic.is_closed %}
        <div class="card-footer bg-transparent">
          <form action="" method="post" class="m-0">
            {% csrf_token %}
            <button type="submit" name="close_conversation" class="btn btn-outline-danger btn-sm">
              Sluit gesprek
            </button>
          </form>
        </div>
      {% endif %}
    </article>

    <!-- Replies header -->
    <h4 class="h5 mb-3">Antwoorden</h4>

    <!-- Replies list -->
    <ul class="list-group mb-4">
      {% for reply in replies %}
        <li class="list-group-item reply-container">

          <div class="d-flex w-100 gap-2">
            <!-- avatar / initials -->
            <div class="circle_user first-letters me-2">{{ reply.created_by.username|upper }}</div>

            <!-- main reply content -->
            <div class="reply-content flex-grow-1">
              <div class="user_chat wrap mb-1">
                <strong>{{ reply.created_by }}</strong>
                <span class="text-muted small">— <time datetime="{{ reply.created_at|date:'c' }}">{{ reply.created_at }}</time></span>
              </div>

              <div class="mb-2">
                {{ reply.content }}
              </div>

              {% if reply.image %}
                <div class="mb-2 image-container">
                  <img src="{{ reply.image.url }}" alt="Reply Image" class="img-fluid img-thumbnail" style="max-width: 240px;">
                </div>
              {% endif %}

              <!-- Child replies -->
              {% if reply.child_replies.all %}
                <ul class="list-group mt-2 nested-replies">
                  {% for child_reply in reply.child_replies.all %}
                    <li class="list-group-item child-reply">
                      <div class="d-flex justify-content-between">
                        <div class="reply-text">
                          <strong>{{ child_reply.created_by }}</strong>:
                          {{ child_reply.content }}
                          <div class="text-muted small">
                            <time datetime="{{ child_reply.created_at|date:'c' }}">{{ child_reply.created_at }}</time>
                          </div>
                        </div>
                        {% if child_reply.created_by == request.user or user.is_superuser %}
                          <form action="{% url 'forum:delete_reply' child_reply.pk %}" method="post" class="ms-2">
                            {% csrf_token %}
                            {% if not topic.is_closed %}
                              <button type="submit" class="btn btn-outline-danger btn-sm" title="Verwijderen">
                                <img src="{% static 'chat/images/delete-icon.png' %}" alt="Delete" width="16" height="16">
                              </button>
                            {% endif %}
                          </form>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>

            <!-- reply / delete actions -->
            <div class="ms-2 d-flex flex-column gap-1">
              {% if not topic.is_closed %}
                <button class="btn btn-outline-primary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#replyModal-{{ reply.pk }}"
                        title="Antwoord">
                  <img src="{% static 'forum/images/reply.png' %}" alt="Reply" width="16" height="16">
                </button>
                {% if reply.created_by == request.user or user.is_superuser %}
                  <form action="{% url 'forum:delete_reply' reply.pk %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Verwijderen">
                      <img src="{% static 'chat/images/delete-icon.png' %}" alt="Delete" width="16" height="16">
                    </button>
                  </form>
                {% endif %}
              {% endif %}
            </div>
          </div>

          <!-- Reply Modal (Bootstrap 5) -->
          <div class="modal fade" id="replyModal-{{ reply.pk }}" tabindex="-1" aria-labelledby="replyModalLabel-{{ reply.pk }}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="replyModalLabel-{{ reply.pk }}">Antwoord op {{ reply.created_by }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
                </div>
                <form method="post" action="{% url 'forum:reply_to_reply' reply.pk %}" enctype="multipart/form-data">
                  {% csrf_token %}
                  <div class="modal-body">
                    {{ form.as_p }}
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Sluit</button>
                    <button type="submit" class="btn btn-green">Stuur antwoord</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

        </li>
      {% empty %}
        <li class="list-group-item">Nog geen antwoorden</li>
      {% endfor %}
    </ul>

    <!-- Add reply -->
    <h4 class="h5 mb-3">Voeg antwoord toe</h4>
    {% if topic.is_closed %}
      <p class="text-muted">*Dit gesprek is gesloten door de maker of beheerder. Antwoorden is niet meer mogelijk.</p>
    {% else %}
      <form method="post" class="mb-4" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group mb-3">
          {{ form.as_p }}
        </div>
        <button type="submit" class="btn btn-green">Stuur</button>
      </form>
    {% endif %}

    <a href="{% url 'forum:topic_list' %}" class="btn btn-outline-secondary btn-sm">Terug naar Topics</a>
  </div>
</section>

{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'forum/scripts/forum.js' %}"></script>
{% endblock %}
